---
import Layout from "../layouts/Layout.astro";
import { getAnilistActivity, parseAnilistProgress } from "../lib/anilist";
import { getTraktHistory } from "../lib/trakt";
import { getRelativeTime } from "../lib/utils";

const anilistData = await getAnilistActivity(20);
const traktData = await getTraktHistory(20);

const items = [
  ...anilistData.map((item) => ({
    id: `al-${item.id}`,
    title: item.media.title.english || item.media.title.romaji,
    image: item.media.coverImage.large,
    progress: parseAnilistProgress(item.status, item.progress, item.media.type),
    date: new Date(item.createdAt * 1000),
    relativeDate: getRelativeTime(new Date(item.createdAt * 1000)),
    type: item.media.type.toLowerCase(), // 'anime' or 'manga'
    url: item.siteUrl || item.media.siteUrl,
  })),
  ...traktData.map((item) => ({
    id: `tr-${item.id}`,
    title: item.type === "episode" ? item.show?.title : item.movie?.title,
    image: item.image,
    progress:
      item.type === "episode"
        ? `s${item.episode?.season}e${item.episode?.number}`
        : "movie",
    date: new Date(item.watched_at),
    relativeDate: getRelativeTime(new Date(item.watched_at)),
    type: item.type === "episode" ? "show" : "movie",
    url:
      item.type === "episode"
        ? `https://trakt.tv/shows/${item.show?.ids.trakt}/seasons/${item.episode?.season}/episodes/${item.episode?.number}`
        : `https://trakt.tv/movies/${item.movie?.ids.trakt}`,
  })),
].sort((a, b) => b.date.getTime() - a.date.getTime());
---

<Layout>
  <div class="flex flex-col gap-8">
    <!-- Header -->
    <h1 class="font-medium text-primary tracking-wide">watch/read</h1>

    <!-- Grid -->
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-8">
      {
        items.map((item) => (
          <a href={item.url} target="_blank" class="flex flex-col gap-2 group">
            <div class="aspect-[2/3] w-full bg-darkblue-200/50 rounded-lg overflow-hidden border border-white/5 relative flex items-center justify-center group-hover:border-white/10 transition-colors">
              {item.image ? (
                <img
                  src={item.image}
                  alt={item.title}
                  class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity duration-300"
                />
              ) : (
                <>
                  {item.type === "manga" && (
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="48"
                      height="48"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="text-primary-opaque/30 group-hover:scale-110 transition-transform"
                    >
                      <path d="M12 12c-2-2-2-5-2-7l2-2 2 2c0 2 0 5-2 7Z" />
                      <path d="M7.5 18a6 6 0 0 0 4.5 3h0a6 6 0 0 0 4.5-3" />
                      <path d="M5 9c0 5 2 9 7 9s7-4 7-9" />
                    </svg>
                  )}
                  {(item.type === "anime" || item.type === "movie") && (
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="48"
                      height="48"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="text-primary-opaque/30 group-hover:scale-110 transition-transform"
                    >
                      <circle cx="12" cy="8" r="5" />
                      <path d="M20 21a8 8 0 0 0-16 0" />
                    </svg>
                  )}
                  {item.type === "show" && (
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="48"
                      height="48"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="text-primary-opaque/30 group-hover:scale-110 transition-transform"
                    >
                      <rect width="20" height="15" x="2" y="7" rx="2" ry="2" />
                      <polyline points="17 2 12 7 7 2" />
                    </svg>
                  )}
                </>
              )}
              <div class="absolute inset-0 bg-gradient-to-t from-darkblue-300/80 to-transparent opacity-60" />
            </div>
            <div class="space-y-1">
              <h3 class="text-accent-blue font-medium text-sm leading-tight line-clamp-2">
                {item.title}
              </h3>
              <div class="flex items-center justify-between text-xs">
                <p class="text-accent-gold font-medium tracking-wide">
                  {item.progress}
                </p>
                <p class="text-primary-opaque/50">{item.relativeDate}</p>
              </div>
            </div>
          </a>
        ))
      }
    </div>
  </div>
</Layout>
